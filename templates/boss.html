<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boss Dashboard - {{ config.app_name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-theme="dark">
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <i class="bi bi-moon-fill" id="themeIcon"></i>
    </div>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <img src="{{ url_for('static', filename='ems-logo.jpeg') }}" alt="EMS Logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
                <a class="navbar-brand" href="#">{{ config.app_name }} - BOSS PANEL</a>
            </div>
            <div class="d-flex">
                <span class="navbar-text me-3">Welcome, {{ session.name }}</span>
                <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Members Management</h5>
                        <div class="d-flex gap-2">
                            {% if is_boss %}
                            <button class="btn btn-info text-white" onclick="exportAllData()">
                                <i class="bi bi-download"></i> Export Data
                            </button>
                            <button class="btn btn-warning" onclick="document.getElementById('importFileInput').click()">
                                <i class="bi bi-upload"></i> Import Data
                            </button>
                            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importAllData(event)">
                            {% endif %}
                            <button class="btn btn-danger" onclick="resetAllMembers()">
                                <i class="bi bi-exclamation-circle"></i> Reset All
                            </button>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                                <i class="bi bi-plus-circle"></i> Add Member
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label fw-bold"><i class="bi bi-megaphone"></i> Announcement Bar</label>
                            <div class="input-group">
                                <textarea class="form-control" id="messageInput" rows="2" placeholder="Type a message for all members"></textarea>
                                <button class="btn btn-primary" type="button" onclick="saveMessage()">
                                    <i class="bi bi-send"></i> Send
                                </button>
                            </div>
                            <div id="messageStatus" class="small mt-1 text-success d-none">Message updated for all members.</div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Post Name</th>
                                        <th>Call Sign</th>
                                        <th>Net Hours</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="membersTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admins & Roles Management (Boss Only) -->
    {% if is_boss %}
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Admins & Roles</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAdminModal">
                                <i class="bi bi-person-plus"></i> Add Admin
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminsTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Admin Modals (Boss Only) -->
    {% if is_boss %}
    <!-- Add Admin Modal -->
    <div class="modal fade" id="addAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addAdminForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="adminName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="adminUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="adminPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select id="adminRole" class="form-select">
                                <option value="boss">DL | Manager</option>
                                <option value="manager">DL | Assistant Manager</option>
                                <option value="moderator">Moderator</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addAdmin()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Admin Modal -->
    <div class="modal fade" id="editAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editAdminForm">
                        <input type="hidden" id="editAdminId">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editAdminName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="editAdminUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select id="editAdminRole" class="form-select">
                                <option value="boss">DL | Manager</option>
                                <option value="manager">DL | Assistant Manager</option>
                                <option value="moderator">Moderator</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Set New Password (optional)</label>
                            <input type="password" class="form-control" id="editAdminPassword" placeholder="Leave blank to keep unchanged">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateAdmin()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="mb-3">
                            <label for="memberName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="memberName" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="memberUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberPostName" class="form-label">Post Name</label>
                            <input type="text" class="form-control" id="memberPostName" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberCallSign" class="form-label">Call Sign</label>
                            <input type="text" class="form-control" id="memberCallSign" required>
                        </div>
                        <div class="mb-3">
                            <label for="memberPassword" class="form-label">Password</label>
                            <input type="text" class="form-control" id="memberPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addMember()">Add Member</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Member Modal -->
    <div class="modal fade" id="editMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editMemberForm">
                        <input type="hidden" id="editMemberId">
                        <div class="mb-3">
                            <label for="editMemberName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="editMemberName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMemberUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editMemberUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMemberPostName" class="form-label">Post Name</label>
                            <input type="text" class="form-control" id="editMemberPostName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMemberCallSign" class="form-label">Call Sign</label>
                            <input type="text" class="form-control" id="editMemberCallSign" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMemberPassword" class="form-label">Password</label>
                            <input type="text" class="form-control" id="editMemberPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateMember()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Employee Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" size="lg">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-vcard"></i> Employee Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Employee Info Section -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Employee Information</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> <span id="detailsMemberName">-</span></p>
                                <p><strong>Username:</strong> <span id="detailsUsername">-</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Post Name:</strong> <span id="detailsPostName">-</span></p>
                                <p><strong>Call Sign:</strong> <span id="detailsCallSign">-</span></p>
                            </div>
                        </div>
                        
                        <!-- Summary Cards (Smaller) -->
                        <div class="row mt-3 mb-3">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white" style="font-size: 0.9rem;">
                                    <div class="card-body py-2">
                                        <h6 class="card-title mb-1" style="font-size: 0.85rem;"><i class="bi bi-clock"></i> Total Hours</h6>
                                        <h5 class="mb-0" id="detailsTotalHours">0 H 0 MIN</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-dark" style="font-size: 0.9rem;">
                                    <div class="card-body py-2">
                                        <h6 class="card-title mb-1" style="font-size: 0.85rem;"><i class="bi bi-pause-circle"></i> Out of Service</h6>
                                        <h5 class="mb-0" id="detailsOutOfService">0 H 0 MIN</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white" style="font-size: 0.9rem;">
                                    <div class="card-body py-2">
                                        <h6 class="card-title mb-1" style="font-size: 0.85rem;"><i class="bi bi-check-circle"></i> Net Hours</h6>
                                        <h5 class="mb-0" id="detailsNetHours">0 H 0 MIN</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                    </div>
                    
                    <!-- Duty Logs Section -->
                    <div>
                        <h6 class="fw-bold mb-3"><i class="bi bi-clock-history"></i> Duty Logs</h6>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>In Time</th>
                                        <th>Out Time</th>
                                        <th>Out of Service</th>
                                        <th>Total Time</th>
                                    </tr>
                                </thead>
                                <tbody id="dutyLogsTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let members = [];
        let entries = [];
        let admins = [];
        let actionPassIsSet = false;

        function formatRole(role) {
            if (role === 'boss') return 'DL | Manager';
            if (role === 'manager') return 'DL | Assistant Manager';
            return 'Moderator';
        }
        
        // Load members
        async function loadMembers() {
            const response = await fetch('/api/members');
            const data = await response.json();
            members = data.members;
            renderMembers();
        }
        
        function renderMembers() {
            const tbody = document.getElementById('membersTableBody');
            tbody.innerHTML = members.map(member => {
                const net = calculateMemberNetHours(member.id);
                return `
                <tr>
                    <td>${member.id}</td>
                    <td>${member.name}</td>
                    <td>${member.username}</td>
                    <td>${member.postname || '-'}</td>
                    <td>${member.callsign || '-'}</td>
                    <td>${net}</td>
                    <td>
                        <button class="btn btn-sm btn-info text-white" onclick="openDetailsModal(${member.id})">
                            <i class="bi bi-eye"></i> Details
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="openEditModal(${member.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="resetMemberEntries(${member.id})">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMember(${member.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        async function addMember() {
            const name = document.getElementById('memberName').value;
            const username = document.getElementById('memberUsername').value;
            const postname = document.getElementById('memberPostName').value;
            const callsign = document.getElementById('memberCallSign').value;
            const password = document.getElementById('memberPassword').value;
            
            const response = await fetch('/api/members', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, username, postname, callsign, password })
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
                document.getElementById('addMemberForm').reset();
                loadMembers();
            }
        }
        
        function openEditModal(memberId) {
            const member = members.find(m => m.id === memberId);
            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editMemberName').value = member.name;
            document.getElementById('editMemberUsername').value = member.username;
            document.getElementById('editMemberPostName').value = member.postname || '';
            document.getElementById('editMemberCallSign').value = member.callsign || '';
            document.getElementById('editMemberPassword').value = member.password;
            new bootstrap.Modal(document.getElementById('editMemberModal')).show();
        }
        
        async function updateMember() {
            const id = document.getElementById('editMemberId').value;
            const name = document.getElementById('editMemberName').value;
            const username = document.getElementById('editMemberUsername').value;
            const postname = document.getElementById('editMemberPostName').value;
            const callsign = document.getElementById('editMemberCallSign').value;
            const password = document.getElementById('editMemberPassword').value;
            
            const response = await fetch(`/api/members/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, username, postname, callsign, password })
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
                loadMembers();
            }
        }
        
        async function deleteMember(memberId) {
            if (confirm('Are you sure you want to delete this member?')) {
                const response = await fetch(`/api/members/${memberId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadMembers();
                }
            }
        }
        
        async function resetMemberEntries(memberId) {
            if (confirm('Are you sure you want to reset all data and hours for this member? This will delete all their time entries.')) {
                const response = await fetch(`/api/members/${memberId}/reset`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadMembers();
                    loadEntries();
                }
            }
        }
        
        async function resetAllMembers() {
            if (confirm('WARNING: This will reset ALL time entries and hours for ALL members! This action cannot be undone. Are you sure?')) {
                const response = await fetch('/api/reset-all', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadMembers();
                    loadEntries();
                }
            }
        }

        async function loadMessage() {
            const response = await fetch('/api/message');
            if (!response.ok) return;
            const data = await response.json();
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = data.message || '';
            }
        }

        async function saveMessage() {
            const messageInput = document.getElementById('messageInput');
            const status = document.getElementById('messageStatus');
            if (!messageInput) return;
            const response = await fetch('/api/message', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: messageInput.value || '' })
            });
            if (response.ok && status) {
                status.classList.remove('d-none');
                status.textContent = 'Message updated for all members.';
                setTimeout(() => status.classList.add('d-none'), 2000);
            }
        }
        
        // Load entries
        async function loadEntries() {
            const response = await fetch('/api/entries');
            const data = await response.json();
            entries = data.entries;
            renderEntries();
            // Re-render members to update net hours column
            renderMembers();
        }

        // Admins management
        async function loadAdmins() {
            const response = await fetch('/api/admins');
            if (!response.ok) return;
            const data = await response.json();
            admins = data.admins || [];
            renderAdmins();
        }

        function renderAdmins() {
            const tbody = document.getElementById('adminsTableBody');
            if (!tbody) return;
            tbody.innerHTML = (admins || []).map(a => `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.name || '-'}</td>
                    <td>${a.username}</td>
                    <td>
                        <span class="badge bg-secondary text-uppercase">${formatRole(a.role)}</span>
                        ${a.permanent ? '<span class="badge bg-danger ms-1"><i class="bi bi-lock"></i> PERMANENT</span>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openAdminEditModal(${a.id})"><i class="bi bi-pencil"></i> Edit</button>
                        ${a.permanent ? '' : `<button class="btn btn-sm btn-danger" onclick="deleteAdmin(${a.id})"><i class="bi bi-trash"></i> Delete</button>`}
                    </td>
                </tr>
            `).join('');
        }

        async function addAdmin() {
            const name = document.getElementById('adminName').value;
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            const role = document.getElementById('adminRole').value;
            const response = await fetch('/api/admins', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, username, password, role })
            });
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addAdminModal')).hide();
                document.getElementById('addAdminForm').reset();
                loadAdmins();
            } else {
                const err = await response.json().catch(() => ({}));
                alert('Failed to add admin: ' + (err.error || response.statusText));
            }
        }

        function openAdminEditModal(adminId) {
            const a = admins.find(x => x.id === adminId);
            if (!a) return;
            document.getElementById('editAdminId').value = a.id;
            document.getElementById('editAdminName').value = a.name || '';
            document.getElementById('editAdminUsername').value = a.username;
            document.getElementById('editAdminRole').value = a.role;
            document.getElementById('editAdminPassword').value = '';
            new bootstrap.Modal(document.getElementById('editAdminModal')).show();
        }

        async function updateAdmin() {
            const id = document.getElementById('editAdminId').value;
            const name = document.getElementById('editAdminName').value;
            const username = document.getElementById('editAdminUsername').value;
            const role = document.getElementById('editAdminRole').value;
            const password = document.getElementById('editAdminPassword').value;
            const payload = { name, username, role };
            if (password) payload.password = password;
            const response = await fetch(`/api/admins/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editAdminModal')).hide();
                loadAdmins();
            } else {
                const err = await response.json().catch(() => ({}));
                alert('Failed to update admin: ' + (err.error || response.statusText));
            }
        }

        async function deleteAdmin(adminId) {
            if (!confirm('Delete this admin?')) return;
            const response = await fetch(`/api/admins/${adminId}`, { 
                method: 'DELETE'
            });
            if (response.ok) {
                loadAdmins();
            } else {
                const err = await response.json().catch(() => ({}));
                alert('Failed to delete admin: ' + (err.error || response.statusText));
            }
        }

        
        function renderEntries() {
            const tbody = document.getElementById('entriesTableBody');
            // If no entries table exists (tab removed), skip rendering
            if (!tbody) return;
            tbody.innerHTML = entries.map(entry => `
                <tr>
                    <td>${entry.id}</td>
                    <td>${entry.member_name}</td>
                    <td>${entry.date}</td>
                    <td>${entry.time_in}</td>
                    <td>${entry.time_out}</td>
                    <td>${entry.total_hours}</td>
                    <td>${entry.out_of_service}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function deleteEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                const response = await fetch(`/api/entries/${entryId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadEntries();
                }
            }
        }
        
        // Export all data
        async function exportAllData() {
            try {
                const response = await fetch('/api/export-all');
                if (!response.ok) throw new Error('Export failed');
                
                const data = await response.json();
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // Create download link
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                link.download = `ems_backup_${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            } catch (error) {
                alert('Error exporting data: ' + error.message);
            }
        }
        
        // Import all data
        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('WARNING: This will replace ALL current data with the imported data! This action cannot be undone. Are you sure?')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                const response = await fetch('/api/import-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('Import failed');
                
                const result = await response.json();
                alert('Data imported successfully!');
                
                // Reload all data
                loadMessage();
                loadMembers();
                loadEntries();
            } catch (error) {
                alert('Error importing data: ' + error.message);
            } finally {
                event.target.value = ''; // Reset file input
            }
        }
        
        // Load data on page load
        loadMessage();
        loadMembers();
        loadEntries();
        loadAdmins();
        
        // Open details modal
        async function openDetailsModal(memberId) {
            const member = members.find(m => m.id === memberId);
            const memberEntries = entries.filter(e => e.member_id === memberId);
            
            // Set member details
            document.getElementById('detailsMemberName').textContent = member.name;
            document.getElementById('detailsPostName').textContent = member.postname || '-';
            document.getElementById('detailsUsername').textContent = member.username;
            document.getElementById('detailsCallSign').textContent = member.callsign || '-';
            
            // Populate duty logs
            const dutyLogsBody = document.getElementById('dutyLogsTableBody');
            if (memberEntries.length === 0) {
                dutyLogsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No duty logs found</td></tr>';
            } else {
                dutyLogsBody.innerHTML = memberEntries.map(entry => {
                    // Convert total hours to "X Hours Y Minutes" format
                    let totalTimeDisplay = entry.total_hours;
                    if (entry.total_hours.includes('H')) {
                        totalTimeDisplay = entry.total_hours.replace('H', 'Hours').replace('MIN', 'Minutes');
                    } else if (entry.total_hours.includes(':')) {
                        const parts = entry.total_hours.split(':');
                        totalTimeDisplay = `${parts[0]} Hours ${parts[1]} Minutes`;
                    }
                    
                    return `
                        <tr>
                            <td>${entry.date}</td>
                            <td>${entry.time_in}</td>
                            <td>${entry.time_out}</td>
                            <td>${entry.out_of_service.includes('H') ? entry.out_of_service.replace('H', 'hours').replace('MIN', 'minutes') : entry.out_of_service + ' min'}</td>
                            <td><strong>${totalTimeDisplay}</strong></td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Calculate and display totals
            calculateEmployeeTotals(memberEntries);
            
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }
        
        // Helper function to format minutes to H MIN format
        function formatMinutesToDisplay(minutes) {
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hrs} H ${mins} MIN`;
        }
        
        // Helper function to parse H MIN format to minutes
        function parseHMinToMinutes(timeStr) {
            if (!timeStr) return 0;
            if (timeStr.includes('H')) {
                const parts = timeStr.split('H');
                const hrs = parseInt(parts[0].trim()) || 0;
                const mins = parseInt(parts[1].trim()) || 0;
                return hrs * 60 + mins;
            }
            if (timeStr.includes(':')) {
                const parts = timeStr.split(':');
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            return parseInt(timeStr) || 0;
        }

        // Calculate net hours for member list
        function calculateMemberNetHours(memberId) {
            const memberEntries = entries.filter(e => e.member_id === memberId);
            let totalMinutes = 0;
            let totalOutOfService = 0;
            
            memberEntries.forEach(entry => {
                totalMinutes += parseHMinToMinutes(entry.total_hours);
                if (entry.out_of_service.includes(':')) {
                    totalOutOfService += parseHMinToMinutes(entry.out_of_service);
                } else if (entry.out_of_service.includes('H')) {
                    totalOutOfService += parseHMinToMinutes(entry.out_of_service);
                } else {
                    totalOutOfService += parseInt(entry.out_of_service) || 0;
                }
            });
            const netMinutes = Math.max(0, totalMinutes - totalOutOfService);
            return formatMinutesToDisplay(netMinutes);
        }
        
        // Calculate employee totals
        function calculateEmployeeTotals(memberEntries) {
            let totalMinutes = 0;
            let totalOutOfService = 0;
            
            memberEntries.forEach(entry => {
                const hours = parseHMinToMinutes(entry.total_hours);
                totalMinutes += hours;
                
                // Parse out_of_service
                if (entry.out_of_service.includes(':')) {
                    totalOutOfService += parseHMinToMinutes(entry.out_of_service);
                } else if (entry.out_of_service.includes('H')) {
                    totalOutOfService += parseHMinToMinutes(entry.out_of_service);
                } else {
                    totalOutOfService += parseInt(entry.out_of_service) || 0;
                }
            });
            
            const netMinutes = Math.max(0, totalMinutes - totalOutOfService);
            
            document.getElementById('detailsTotalHours').textContent = formatMinutesToDisplay(totalMinutes);
            document.getElementById('detailsOutOfService').textContent = formatMinutesToDisplay(totalOutOfService);
            document.getElementById('detailsNetHours').textContent = formatMinutesToDisplay(netMinutes);
        }
        
        // Theme Toggle Function
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'light') {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
            } else {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
            }
        });
    </script>
</body>
</html>
