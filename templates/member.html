<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Dashboard - {{ config.app_name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body data-theme="dark">
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
        <i class="bi bi-moon-fill" id="themeIcon"></i>
    </div>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <img src="{{ url_for('static', filename='ems-logo.jpeg') }}" alt="EMS Logo" style="height: 40px; margin-right: 15px; border-radius: 4px;">
                <a class="navbar-brand" href="#">{{ config.app_name }} - MEMBER PANEL</a>
            </div>
            <div class="d-flex">
                <span class="navbar-text me-3">Welcome, {{ session.name }}</span>
                <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div id="messageAlert" class="alert alert-info d-flex align-items-center mb-4">
                    <i class="bi bi-megaphone-fill me-2"></i>
                    <div id="messageText">No message from boss yet.</div>
                </div>
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-clock"></i> Total Working Hours</h6>
                                <h2 class="mb-0" id="totalWorkingHours"><span class="h-display">0 H 0 MIN</span></h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-pause-circle"></i> Total Out of Service</h6>
                                <h2 class="mb-0" id="totalOutOfService"><span class="h-display">0 H 0 MIN</span></h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-check-circle"></i> Net Working Hours <small class="text-light">(After Out of Service)</small></h6>
                                <h2 class="mb-0" id="netWorkingHours"><span class="h-display">0 H 0 MIN</span></h2>
                               
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add Time Entry</h5>
                    </div>
                    <div class="card-body">
                        <form id="addEntryForm" class="row g-3">
                            <div class="col-md-3">
                                <label for="entryDate" class="form-label"><i class="bi bi-calendar3"></i> Date</label>
                                <input type="text" class="form-control" id="entryDate" placeholder="Select date" required readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="entryTimeIn" class="form-label"><i class="bi bi-clock"></i> Time In</label>
                                <input type="time" class="form-control" id="entryTimeIn" required onchange="calculateTotalHours()">
                            </div>
                            <div class="col-md-2">
                                <label for="entryTimeOut" class="form-label"><i class="bi bi-clock-fill"></i> Time Out</label>
                                <input type="time" class="form-control" id="entryTimeOut" required onchange="calculateTotalHours()">
                            </div>
                            <div class="col-md-2">
                                <label for="entryTotalHours" class="form-label"><i class="bi bi-hourglass-split"></i> Total Hours</label>
                                <input type="text" class="form-control bg-light" id="entryTotalHours" placeholder="Auto" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="entryOutOfService" class="form-label"><i class="bi bi-pause"></i> Out of Service (min)</label>
                                <input type="number" class="form-control" id="entryOutOfService" placeholder="0" value="0" min="0">
                            </div>
                            <div class="col-md-1 d-flex align-items-end">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="bi bi-check-circle"></i> Add
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> My Time Entries</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time In</th>
                                        <th>Time Out</th>
                                        <th>Total Hours</th>
                                        <th>Out of Service</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Change Password Card (Bottom with Gap) -->
                <div class="card mt-5">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-key"></i> Change Password</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="password" id="memberCurrentPass" class="form-control" placeholder="Current password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('memberCurrentPass', 'currentPassIcon')">
                                        <i class="bi bi-eye" id="currentPassIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="password" id="memberNewPass" class="form-control" placeholder="New password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('memberNewPass', 'newPassIcon')">
                                        <i class="bi bi-eye" id="newPassIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="changeMemberPassword()">Update</button>
                            </div>
                            <div class="col-md-2">
                                <div id="memberPassStatus" class="small text-muted"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Entry Modal -->
    <div class="modal fade" id="editEntryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Time Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEntryForm">
                        <input type="hidden" id="editEntryId">
                        <div class="mb-3">
                            <label for="editEntryDate" class="form-label"><i class="bi bi-calendar3"></i> Date</label>
                            <input type="text" class="form-control" id="editEntryDate" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editEntryTimeIn" class="form-label"><i class="bi bi-clock"></i> Time In</label>
                            <input type="time" class="form-control" id="editEntryTimeIn" required onchange="calculateEditTotalHours()">
                        </div>
                        <div class="mb-3">
                            <label for="editEntryTimeOut" class="form-label"><i class="bi bi-clock-fill"></i> Time Out</label>
                            <input type="time" class="form-control" id="editEntryTimeOut" required onchange="calculateEditTotalHours()">
                        </div>
                        <div class="mb-3">
                            <label for="editEntryTotalHours" class="form-label"><i class="bi bi-hourglass-split"></i> Total Hours</label>
                            <input type="text" class="form-control bg-light" id="editEntryTotalHours" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="editEntryOutOfService" class="form-label"><i class="bi bi-pause"></i> Out of Service (minutes)</label>
                            <input type="number" class="form-control" id="editEntryOutOfService" required min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateEntry()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        let entries = [];
        let datePicker, timeInPicker, timeOutPicker;
        let editDatePicker, editTimeInPicker, editTimeOutPicker;

        async function loadMessage() {
            try {
                const response = await fetch('/api/message');
                if (!response.ok) return;
                const data = await response.json();
                const messageText = document.getElementById('messageText');
                const alertBox = document.getElementById('messageAlert');
                if (messageText && alertBox) {
                    const text = (data.message || '').trim();
                    messageText.textContent = text || 'No message from boss yet.';
                    alertBox.classList.toggle('alert-info', !!text);
                    alertBox.classList.toggle('alert-secondary', !text);
                }
            } catch (err) {
                // ignore fetch errors
            }
        }
        
        // Initialize date and time pickers
        document.addEventListener('DOMContentLoaded', function() {
            // Add entry form pickers
            datePicker = flatpickr("#entryDate", {
                dateFormat: "d-m-Y",
                defaultDate: new Date(),
                maxDate: new Date()
            });
            
            // Time pickers now use native HTML5 time inputs
            // with onchange handlers for better UX
            
            // Edit modal pickers
            editDatePicker = flatpickr("#editEntryDate", {
                dateFormat: "d-m-Y",
                maxDate: new Date()
            });
            
            // Edit modal time pickers now use native HTML5 time inputs
            // with onchange handlers for better UX
            
            // Load data on page load
            loadMessage();
            loadEntries();
        });
        
        // Calculate total hours automatically
        function calculateTotalHours() {
            const timeIn = document.getElementById('entryTimeIn').value;
            const timeOut = document.getElementById('entryTimeOut').value;
            
            if (timeIn && timeOut) {
                const total = calculateHoursDifference(timeIn, timeOut);
                document.getElementById('entryTotalHours').value = total;
            }
        }
        
        function calculateEditTotalHours() {
            const timeIn = document.getElementById('editEntryTimeIn').value;
            const timeOut = document.getElementById('editEntryTimeOut').value;
            
            if (timeIn && timeOut) {
                const total = calculateHoursDifference(timeIn, timeOut);
                document.getElementById('editEntryTotalHours').value = total;
            }
        }
        
        function calculateHoursDifference(timeIn, timeOut) {
            const parseTime = (timeStr) => {
                const [time, period] = timeStr.split(' ');
                let [hours, minutes] = time.split(':').map(Number);
                
                if (period === 'PM' && hours !== 12) hours += 12;
                if (period === 'AM' && hours === 12) hours = 0;
                
                return hours * 60 + minutes;
            };
            
            let inMinutes = parseTime(timeIn);
            let outMinutes = parseTime(timeOut);
            
            // Handle overnight shift
            if (outMinutes < inMinutes) {
                outMinutes += 24 * 60;
            }
            
            const diffMinutes = outMinutes - inMinutes;
            const hours = Math.floor(diffMinutes / 60);
            const minutes = diffMinutes % 60;
            
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }
        
        function formatMinutesToHHMM(minutes) {
            const hrs = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hrs} H ${mins} MIN`;
        }
        
        function parseHHMMToMinutes(timeStr) {
            if (!timeStr) return 0;
            // Handle both "HH:MM" and "H H MM MIN" formats
            if (timeStr.includes('H')) {
                const parts = timeStr.split('H');
                const hrs = parseInt(parts[0].trim()) || 0;
                const mins = parseInt(parts[1].trim()) || 0;
                return hrs * 60 + mins;
            }
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        
        // Calculate totals
        function calculateTotals() {
            let totalMinutes = 0;
            let totalOutOfService = 0;
            
            entries.forEach(entry => {
                const hours = parseHHMMToMinutes(entry.total_hours);
                totalMinutes += hours;
                
                // Parse out_of_service (could be "00:00", "0", or "H H MIN" format)
                if (entry.out_of_service.includes(':')) {
                    totalOutOfService += parseHHMMToMinutes(entry.out_of_service);
                } else if (entry.out_of_service.includes('H')) {
                    totalOutOfService += parseHHMMToMinutes(entry.out_of_service);
                } else {
                    totalOutOfService += parseInt(entry.out_of_service) || 0;
                }
            });
            
            // Calculate net working hours (total - out of service)
            const netMinutes = Math.max(0, totalMinutes - totalOutOfService);
            
            document.getElementById('totalWorkingHours').innerHTML = formatMinutesToHHMM(totalMinutes);
            document.getElementById('totalOutOfService').innerHTML = formatMinutesToHHMM(totalOutOfService);
            document.getElementById('netWorkingHours').innerHTML = formatMinutesToHHMM(netMinutes);
        }
        
        // Load entries
        async function loadEntries() {
            const response = await fetch('/api/entries');
            const data = await response.json();
            entries = data.entries;
            renderEntries();
            calculateTotals();
        }
        
        function renderEntries() {
            const tbody = document.getElementById('entriesTableBody');
            
            if (!entries || entries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No duty logs found</td></tr>`;
                return;
            }
            
            tbody.innerHTML = entries.map(entry => {
                // Format out_of_service display
                let outOfServiceDisplay = entry.out_of_service;
                if (!entry.out_of_service.includes(':')) {
                    const mins = parseInt(entry.out_of_service) || 0;
                    outOfServiceDisplay = formatMinutesToHHMM(mins);
                }
                
                return `
                <tr>
                    <td>${entry.date}</td>
                    <td>${entry.time_in}</td>
                    <td>${entry.time_out}</td>
                    <td><strong class="text-primary">${entry.total_hours}</strong></td>
                    <td>${outOfServiceDisplay}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="openEditModal(${entry.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEntry(${entry.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // Add entry
        document.getElementById('addEntryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const date = document.getElementById('entryDate').value;
            const time_in = document.getElementById('entryTimeIn').value;
            const time_out = document.getElementById('entryTimeOut').value;
            const total_hours = document.getElementById('entryTotalHours').value;
            const out_of_service = document.getElementById('entryOutOfService').value || '0';
            
            if (!date || !time_in || !time_out || !total_hours) {
                alert('Please fill in all required fields');
                return;
            }
            
            const response = await fetch('/api/entries', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time_in, time_out, total_hours, out_of_service })
            });
            
            if (response.ok) {
                document.getElementById('addEntryForm').reset();
                document.getElementById('entryOutOfService').value = '0';
                document.getElementById('entryTotalHours').value = '';
                datePicker.setDate(new Date());
                // Clear time inputs (native HTML5 time inputs)
                document.getElementById('entryTimeIn').value = '';
                document.getElementById('entryTimeOut').value = '';
                loadEntries();
            }
        });
        
        function openEditModal(entryId) {
            const entry = entries.find(e => e.id === entryId);
            document.getElementById('editEntryId').value = entry.id;
            
            // Set date using Flatpickr
            editDatePicker.setDate(entry.date, false, 'd-m-Y');
            
            // Convert 12-hour format to 24-hour format for HTML5 time input
            function convertTo24Hour(time12h) {
                if (!time12h) return '';
                const [time, modifier] = time12h.split(' ');
                let [hours, minutes] = time.split(':');
                
                if (hours === '12') {
                    hours = '00';
                }
                
                if (modifier === 'PM') {
                    hours = parseInt(hours, 10) + 12;
                }
                
                return `${hours.toString().padStart(2, '0')}:${minutes}`;
            }
            
            // Set time inputs
            document.getElementById('editEntryTimeIn').value = convertTo24Hour(entry.time_in);
            document.getElementById('editEntryTimeOut').value = convertTo24Hour(entry.time_out);
            
            document.getElementById('editEntryTotalHours').value = entry.total_hours;
            
            // Handle out_of_service format
            let outOfService = entry.out_of_service;
            if (entry.out_of_service.includes(':')) {
                outOfService = parseHHMMToMinutes(entry.out_of_service);
            }
            document.getElementById('editEntryOutOfService').value = outOfService;
            
            // Calculate total hours
            calculateEditTotalHours();
            
            new bootstrap.Modal(document.getElementById('editEntryModal')).show();
        }
        
        async function updateEntry() {
            const id = document.getElementById('editEntryId').value;
            const date = document.getElementById('editEntryDate').value;
            const time_in = document.getElementById('editEntryTimeIn').value;
            const time_out = document.getElementById('editEntryTimeOut').value;
            const total_hours = document.getElementById('editEntryTotalHours').value;
            const out_of_service = document.getElementById('editEntryOutOfService').value || '0';
            
            const response = await fetch(`/api/entries/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time_in, time_out, total_hours, out_of_service })
            });
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editEntryModal')).hide();
                loadEntries();
            }
        }
        
        async function deleteEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                const response = await fetch(`/api/entries/${entryId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadEntries();
                }
            }
        }

        async function changeMemberPassword() {
            const current = document.getElementById('memberCurrentPass').value;
            const newPass = document.getElementById('memberNewPass').value;
            const status = document.getElementById('memberPassStatus');
            if (!current || !newPass) {
                if (status) status.textContent = 'Enter current and new password';
                return;
            }
            const response = await fetch('/api/members/me/password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_password: current, new_password: newPass })
            });
            if (status) {
                if (response.ok) {
                    status.textContent = 'Password updated';
                    status.classList.remove('text-danger');
                    status.classList.add('text-success');
                    document.getElementById('memberCurrentPass').value = '';
                    document.getElementById('memberNewPass').value = '';
                } else {
                    const err = await response.json().catch(() => ({}));
                    status.textContent = err.error || 'Update failed';
                    status.classList.remove('text-success');
                    status.classList.add('text-danger');
                }
                setTimeout(() => { status.textContent = ''; }, 2500);
            }
        }
        
        // Theme Toggle Function
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            body.setAttribute('data-theme', savedTheme);
            if (savedTheme === 'light') {
                themeIcon.classList.remove('bi-moon-fill');
                themeIcon.classList.add('bi-sun-fill');
            } else {
                themeIcon.classList.remove('bi-sun-fill');
                themeIcon.classList.add('bi-moon-fill');
            }
        });
        
        // Toggle Password Visibility Function
        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }
    </script>
</body>
</html>
